<template>
    <div class="m-publish-box">
        <!-- Â§¥ÈÉ® -->
        <publish-header name="Ââë‰∏âÂ∞èÂÜå" :localDraft="false">
            <slot name="header"></slot>
        </publish-header>

        <el-form label-position="left" class="m-publish-collection">
            <!-- üíõ Ê†èÁõÆÂ≠óÊÆµ -->
            <div class="m-publish-title">
                <el-divider content-position="left">Ê†áÈ¢ò</el-divider>
                <el-input
                    v-model="collection.title"
                    placeholder="ËØ∑ËæìÂÖ•Â∞èÂÜåÊ†áÈ¢ò"
                    maxlength="30"
                    show-word-limit
                ></el-input>
            </div>

            <div class="m-publish-primary">
                <div class="m-publish-primary-block">
                    <el-divider content-position="left">ÂèØËßÅÊÄß</el-divider>
                    <el-radio v-model.number="collection.public" :label="this.public.PUBLIC">ÂÖ¨ÂºÄ</el-radio>
                    <el-radio v-model.number="collection.public" :label="this.public.PRIVATE">ÁßÅÊúâ</el-radio>
                    <el-tooltip content="ÁßÅÊúâ‰ªÖ‰ΩøËØ•Â∞èÂÜå‰∏çÂá∫Áé∞Âú®ÂÖ¨ÂºÄÂ∞èÂÜåÂ§ßÂéÖ‰∏≠" placement="top">
                        <i class="el-icon-info"></i>
                    </el-tooltip>
                </div>
                <div class="m-publish-primary-block m-publish-collection-posts">
                    <el-divider content-position="left">ÂÜÖÂÆπ</el-divider>
                    <draggable
                        class="m-list-style"
                        tag="ul"
                        v-if="collection.posts && collection.posts.length"
                        :list="collection.posts"
                        handle=".u-move"
                    >
                        <li v-for="(item, key) in collection.posts" :key="key" class="c-posts-item">
                            <i class="u-move el-icon-more"></i>
                            <i class="u-delete el-icon-close" @click="collection.posts.splice(key, 1)"></i>
                            <el-row class="m-posts-item" :gutter="10">
                                <el-col :span="4" class="u-collection-type">
                                    <el-select
                                        class="u-item-key"
                                        v-model="item.type"
                                        placeholder="ËØ∑ÈÄâÊã©‰ΩúÂìÅÁ±ªÂûã"
                                        @change="
                                            () => {
                                                search_handle(null, item);
                                                item.url = item.title = '';
                                            }
                                        "
                                    >
                                        <el-option
                                            v-for="(type, k) in source_types"
                                            :label="type"
                                            :key="k"
                                            :value="k"
                                        ></el-option>
                                    </el-select>
                                </el-col>
                                <el-col :span="8" class="u-collection-id">
                                    <el-select
                                        v-if="item.type !== 'custom'"
                                        class="u-item-value"
                                        v-model="item.id"
                                        filterable
                                        remote
                                        placeholder="ÈÄöËøáËæìÂÖ•‰ΩúÂìÅÊ†áÈ¢òËøõË°åÊêúÁ¥¢"
                                        :remote-method="
                                            (query) => {
                                                search_handle(query, item);
                                            }
                                        "
                                        @change="
                                            (post_id) => {
                                                title_fill(post_id, item);
                                            }
                                        "
                                        :disabled="!item.type"
                                    >
                                        <template v-for="post in item.posts">
                                            <el-option
                                                v-if="post.id && post.title"
                                                :key="post.id"
                                                :value="post.id"
                                                :label="post.title"
                                            >
                                                <div>
                                                    <el-tag size="small" v-if="post.post_type">{{  showPostType(post.post_type) }}</el-tag>
                                                    {{ post.title }}
                                                </div>
                                            </el-option>
                                        </template>
                                    </el-select>
                                    <el-input
                                        class="u-item-value"
                                        placeholder="ËØ∑ËæìÂÖ•ÂÆåÊï¥ÁΩëÈ°µÈìæÊé•ÔºàÈúÄ‰ª•HTTPÊàñHTTPSÂºÄÂ§¥Ôºâ"
                                        v-else
                                        v-model.trim="item.url"
                                    ></el-input>
                                </el-col>
                                <el-col :span="12" class="u-collection-url" v-if="item.url">
                                    <el-input v-model="item.title" placeholder="ËØ∑ËæìÂÖ•Ëá™ÂÆö‰πâÊ†áÈ¢ò"></el-input>
                                </el-col>
                            </el-row>
                        </li>
                    </draggable>
                    <div v-else class="u-posts-items-empty">ÊöÇÊó†‰ΩúÂìÅ‰ø°ÊÅØÔºåËØ∑ËøõË°å‰ΩúÂìÅÊ∑ªÂä†</div>
                    <div class="u-posts-add" @click="add_posts_item">
                        <i class="el-icon-plus"></i>
                        <span>Ê∑ªÂä†‰ΩúÂìÅ</span>
                    </div>
                </div>

                <div class="m-publish-primary-block m-publish-description">
                    <el-divider content-position="left" @click="show_description = !show_description"
                        >ÊèèËø∞ÔºàÈÄâÂ°´Ôºâ</el-divider
                    >
                    <span v-if="!show_description" @click="show_description = true" class="u-show">‚ñº Â±ïÂºÄ</span>
                    <span v-if="show_description" @click="show_description = false" class="u-hide">‚ñ≤ Êî∂Ëµ∑</span>
                    <Tinymce
                        v-show="show_description"
                        v-model="collection.description"
                        :attachmentEnable="true"
                        :resourceEnable="true"
                        :height="300"
                    />
                </div>
            </div>
            <div class="m-publish-collection-publish">
                <el-button class="u-button" type="primary" @click="submit" :loading="processing" :disabled="processing"
                    >Âèë &nbsp;&nbsp; Â∏É</el-button
                >
            </div>
        </el-form>
    </div>
</template>

<script>
import { __Root, __postType, __wikiType, __appType } from "@jx3box/jx3box-common/data/jx3box.json";
import Tinymce from "@jx3box/jx3box-editor/src/Tinymce";
import CollectionPublic from "@jx3box/jx3box-editor/service/enum/CollectionPublic";
import header from "@/components/publish_header.vue";
// import publish_banner from "@/components/publish_banner.vue";
import draggable from "vuedraggable";

// Êú¨Âú∞‰æùËµñ
import { createCollection, updateCollection, getCollectionRaw } from "../service/collection";
import { get_posts_by_type } from "../service/post";
import { getMyPosts, getAllPosts } from "@/service/cms";
import { getAllFaceList } from "@/service/face";
import { getLink } from "@jx3box/jx3box-common/js/utils";
import lodash from "lodash";

export default {
    name: "collection",
    props: [],
    data() {
        // ‰ΩúÂìÅÁ±ªÂûãÂä†ËΩΩ
        let source_types = Object.assign({ mine: "ÊàëÁöÑ‰ΩúÂìÅ", all: 'ÂÖ®ÈÉ®‰ΩúÂìÅ', custom: "Ëá™ÂÆö‰πâ" }, __postType, __wikiType, { face: "ÊçèËÑ∏" });
        delete source_types.jx3dat;
        delete source_types.notice;

        return {
            source_types: source_types,
            public: CollectionPublic,
            // Ââë‰∏âÂ∞èÂÜå‰∏ª‰Ωì
            collection: {
                id: "",
                title: "",
                public: 1,
                image: "",
                description: "",
                tags: [],
                posts: [],
            },
            tag: "",
            legal_tags: null,
            show_description: true,
            processing: false,
        };
    },
    computed: {
        id: function () {
            return this.$route.params.collection_id;
        },
    },
    methods: {
        tags_filters(query) {
            let output = [];
            for (let tag of this.legal_tags) {
                if (tag.split(query).length > 1) output.push({ value: tag });
            }
            return output;
        },
        // Â∏ñÂ≠êÊ†áÈ¢òÂ°´ÂÖÖ
        title_fill(post_id, item) {
            let post = item.posts[post_id];
            item.title = post && post.title ? post.title : "";
            item.post_type = post && post.post_type ? post.post_type : "";
        },
        add_posts_item() {
            this.collection.posts.push({
                title: "",
                type: "",
                id: "",
                url: "",
                posts: null,
                post_type: "",
            });
        },
        search_handle(queryString, item) {
            if (queryString === null) item.id = queryString = "";
            if (item.type === 'face') {
                getAllFaceList({
                    title: queryString,

                }).then(res => {
                    item.posts = res.data.data.list?.reduce((acc, cur) => {
                        acc[cur.id] = {
                            id: cur.id,
                            title: cur.title,
                            type: 'face'
                        }
                        return acc
                    }, {}) || {};
                })
            } else if (item.type === 'mine') {
                getMyPosts({
                    title: queryString,
                }).then(res => {
                    item.posts = res.data.data.list?.reduce((acc, cur) => {
                        acc[cur.ID] = {
                            id: cur.ID,
                            title: cur.post_title,
                            post_type: cur.post_type
                        }
                        return acc
                    }, {}) || {};
                })
            } else if (item.type === 'all') {
                const params = {};
                if (queryString) {
                    params.title = queryString;
                }
                getAllPosts(params).then(res => {
                    item.posts = res.data.data.list?.reduce((acc, cur) => {
                        acc[cur.ID] = {
                            id: cur.ID,
                            title: cur.post_title,
                            post_type: cur.post_type
                        }
                        return acc
                    }, {}) || {};
                })
            } else {
                get_posts_by_type(item.type, {
                    public: 1,
                    keyword: queryString,
                }).then((res) => {
                    res = res.data;
                    if (res.code === 200) {
                        item.posts = res.data.posts;
                    }
                });
            }
        },
        init: function () {
            getCollectionRaw(this.id).then((res) => {
                let collection = res.data.data;
                if (collection) {
                    for (let i in collection.posts) {
                        let item = collection.posts[i];
                        collection.posts[i].posts =
                            item.type === "custom" ? null : [{ id: item.id, title: item.title, post_type: item.post_type }];
                    }
                    this.collection = collection;
                } else {
                    this.$message({
                        message: "ËØ•Ââë‰∏âÂ∞èÂÜåÂ∑≤Ë¢´Âà†Èô§ÊàñÊó†ÊùÉÈôêËÆøÈóÆ",
                        type: "warning",
                    });
                }
            });
        },
        submit: function () {
            // this.$confirm("Á°ÆÂÆöÊèê‰∫§Ââë‰∏âÂ∞èÂÜå‰ø°ÊÅØÔºü", "ÊèêÁ§∫", {
            //     type: "info",
            // }).then(() => {
            // Ê†áÈ¢òÈïøÂ∫¶ÈôêÂà∂
            // this.collection.title = this.collection.title.slice(0,40);

            let collection = JSON.parse(JSON.stringify(this.collection));

            if (!collection.posts) {
                collection.posts = [];
            }

            // Ê†°È™åposts
            let message = "";
            for (const i in collection.posts) {
                const item = collection.posts[i];
                if (!item.type) {
                    message = "ÊñáÁ´†Á±ªÂûã‰∏çËÉΩ‰∏∫Á©∫Âì¶";
                    break;
                }
                if (!item.id) {
                    message = "ËØ∑ÈÄâÊã©ÂØπÂ∫îÁöÑÊñáÁ´†";
                    break;
                }
                if (!item.title) {
                    message = "ËØ∑Â°´ÂÜôËá™ÂÆö‰πâÈìæÊé•ÁöÑÊ†áÈ¢ò";
                    break;
                }
                if (item.type === 'custom' && !item.url) {
                    message = "ËØ∑Â°´ÂÜôÊ≠£Á°ÆÁöÑÂ∞èÂÜåÊñáÁ´†ÈìæÊé•ÔºàhttpÊàñhttpsÂºÄÂ§¥Ôºâ";
                    break;
                }
            }
            // Êõ¥Êñ∞sortÂ≠óÊÆµ
            collection.posts.forEach((item, index) => {
                item.sort = index;
            });
            if (message) {
                this.$message({
                    message: message,
                    type: "warning",
                });
                return
            }

            // ÂéªÈô§Â§ö‰ΩôÂ≠óÊÆµ
            for (let i in collection.posts) delete collection.posts[i].posts;
            collection.posts = JSON.stringify(collection.posts);

            this.processing = true;
            let fn = ''
            if (this.id) {
                collection = lodash.pick(collection, ["title", "public", "image", "description", "mark", "posts"]);
                fn = updateCollection(this.id, collection);
            } else {
                collection = lodash.omit(collection, ["id", 'tags']);
                fn = createCollection(collection)
            }
            fn.then((res) => {
                this.$message({
                    message: this.id ? 'Êõ¥Êñ∞ÊàêÂäü' : 'ÂàõÂª∫ÊàêÂäü',
                    type: "success",
                });
                let id = this.id || res.data.data.id;
                setTimeout(() => {
                    location.href = getLink("collection", id);
                }, 500);
            })
            .finally(() => {
                this.processing = false;
            });
        },

        showPostType: function (type){
            return __postType[type]
        }
    },
    watch: {
        id: {
            immediate: true,
            handler: function (val) {
                val && this.init();
                if (!val) {
                    this.source_types = {
                        mine: 'ÊàëÁöÑ‰ΩúÂìÅ',
                        all: 'ÂÖ®ÈÉ®‰ΩúÂìÅ',
                        custom: 'Ëá™ÂÆö‰πâ',
                    }
                }
            },
        },
    },
    components: {
        Tinymce,
        draggable,
        "publish-header": header,
        // "publish-banner": publish_banner,
    },
};
</script>

<style scoped lang="less">
@import "../assets/css/collection.less";
</style>
